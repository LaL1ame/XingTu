# 基础项目报告


## 整体设计

项目采用**模块化设计**，以 `MainActivity` 作为主容器，通过底部导航栏管理多个 Fragment：

```
MainActivity (底部导航栏管理)
├── BlankFragment1 (修图页/首页)
│   ├── ViewPager2 (轮播图 + GradientOverlayView 渐变效果)
│   ├── RecyclerView (横向媒体展示：图片 + 视频)
│   └── VideoPlayerHolder (单例播放器管理)
│
└── BlankFragment3 (我的页)
```

### 核心模块

#### 1. 首页模块
- **ViewPager2**：自定义的炫酷View，顶部轮播图，自动播放，使用 `LinearGradient` 在 `GradientOverlayView` 中实现渐变效果
- **RecyclerView**：横向滑动媒体列表（图片 + 视频混合展示，实现多媒体展示，mp4、png）
- **VideoPlayerHolder**：单例模式管理 ExoPlayer，避免资源浪费，
- **GradientOverlayView**：自定义渐变覆盖层，使用 `LinearGradient` 实现视觉效果

#### 2. 相册页模块
- **AlbumActivity**：独立的 Activity，负责媒体库访问
- **MediaStore API**：异步查询图片和视频，按日期倒序排列
- **MediaAdapter**：3 列网格布局展示缩略图
- **权限管理**：适配 Android 13+ 新权限模型，兼容不同厂商设备

#### 3. 编辑器页模块
- **GLSurfaceView + ImageRenderer**：OpenGL ES 2.0 渲染画布
  - MVP 矩阵变换（缩放、平移、旋转）
  - FBO 离屏渲染用于导出
- **EditHistoryManager**：操作历史管理，支持撤销/重做

---

# 开发遇到的困难

## 首页模块

在开发首页时遇到两个问题：

1. 无法在"修图"页直接退出应用：在 BlankFragment1（修图页）按返回键时，应用不会退出，而是先回到主容器MainAcitvity（空白）。
2. 返回键导致反复跳转：在"修图"页和"我的"页之间反复跳转，无法正常退出。

### 问题原因

1. Fragment 返回栈管理不当：

- 切换到"我的"页时使用了 replaceFragment(BlankFragment3(), true)，将 Fragment 加入返回栈。

- 从"我的"页返回时，系统会弹出返回栈，但逻辑处理不当，导致跳转回"修图"页。

- "修图"页作为首页，不应依赖返回栈，应直接退出应用。

1. 返回键处理缺失：

没有自定义返回键处理，系统默认行为不符合预期。

### 解决方案

- 使用 OnBackPressedCallback 拦截返回键。

- 在"修图"页直接调用 finish() 退出应用。

- 从"我的"页返回时，切换到"修图"页且不加入返回栈（addToBackStack = false），避免循环跳转。

- 切换 Fragment 时，根据页面类型决定是否加入返回栈：

​		"修图"页：不加入返回栈（首页）

​		"我的"页：加入返回栈（可返回）

这样即可实现：在"修图"页按返回键直接退出应用，从"我的"页返回时回到"修图"页，且不会出现循环跳转。

## 相册页模块

在相册页上下滑动时十分卡顿

### 问题原因

**没有缓存机制**

- 每次滑动都会重新加载图片
- 向上滑动再向下滑动，同样的图片要重新加载
- 结果：重复加载，浪费资源

### 解决方案

通过 MediaStore Thumbnails API使用系统缓存的缩略图，避免加载原图，减少内存占用，并且用异步加载，不阻塞主线程ui更新



## 编辑器页模块

在导出编辑好的图片时，在虚拟机上运行没有问题，但是到真机上导出的图片是全黑的，无论怎么平移旋转甚至不去做任何操作直接导出都不改变结果。

### 可能原因？

- 虚拟机对线程检查较宽松，可能允许跨线程操作

- 真机更严格，必须在正确的线程执行 OpenGL 操作

### 解决方案

使用 queueEvent() + getMainHandler().post() 的组合：

- 使用 queueEvent() 确保在 GL 线程执行，将代码块放入 GL 渲染线程队列，确保在正确的线程执行 FBO 渲染

- getMainHandler().post()：将结果从 GL 线程切换回主线程，用于更新 UI 和保存图片

---

## 